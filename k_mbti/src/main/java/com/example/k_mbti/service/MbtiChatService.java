package com.example.k_mbti.service;

import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;

@Service
public class MbtiChatService {

    // MBTI ê·¸ë£¹ë³„ ê¸°ë³¸ ë§íˆ¬/ì‘ë‹µ í…œí”Œë¦¿
    private static final Map<String, String> MBTI_TONE = Map.ofEntries(
            Map.entry("ENFP", "ë˜ê²Œ ììœ ë¡­ê³  ì¹œê·¼í•˜ê²Œ, ê°ì • ë§ì´ ë‹´ì•„ì„œ"),
            Map.entry("INFP", "ì¡°ê¸ˆ ì¡°ì‹¬ìŠ¤ëŸ½ê³  ê³µê° ìœ„ì£¼ë¡œ, ë§íˆ¬ëŠ” ë¶€ë“œëŸ½ê²Œ"),
            Map.entry("ENTJ", "ì§ì„¤ì ì´ê³  ê³„íšì ìœ¼ë¡œ, í•´ê²°ì±… ìœ„ì£¼ë¡œ"),
            Map.entry("INTJ", "ë…¼ë¦¬ì ìœ¼ë¡œ, ì°¨ë¶„í•˜ê²Œ, ê°ì •ë³´ë‹¤ëŠ” êµ¬ì¡°ì ìœ¼ë¡œ"),
            Map.entry("ESFJ", "ìƒëŒ€ ê¸°ë¶„ì„ ë§ì´ ì±™ê¸°ë©´ì„œ, ë”°ëœ»í•˜ê²Œ"),
            Map.entry("ISFJ", "ë°°ë ¤ ë„˜ì¹˜ê³  ì¡°ì‹¬ìŠ¤ëŸ¬ìš´ ë§íˆ¬ë¡œ"),
            Map.entry("ESTP", "ê°€ë³ê²Œ, ìœ ë¨¸ ì„ìœ¼ë©´ì„œ í˜„ì‹¤ì ì¸ í†¤ìœ¼ë¡œ"),
            Map.entry("ISTP", "ê°„ë‹¨ëª…ë£Œí•˜ê²Œ, ì¿¨í•œ ëŠë‚Œìœ¼ë¡œ")
            // ë‚˜ë¨¸ì§€ MBTIë„ ì›í•˜ë©´ ì¶”ê°€ ê°€ëŠ¥
    );

    public String generateReply(String mbti, String message) {
        mbti = mbti != null ? mbti.toUpperCase() : "ENFP";

        // 1. ê¸°ë³¸ í†¤ ê°€ì ¸ì˜¤ê¸°
        String tone = MBTI_TONE.getOrDefault(mbti, "í¸í•œ ì¹œêµ¬ì²˜ëŸ¼ ìì—°ìŠ¤ëŸ½ê²Œ");

        // 2. ê°„ë‹¨í•œ í‚¤ì›Œë“œ ê¸°ë°˜ ë°˜ì‘ ì˜ˆì‹œ
        message = message.trim();

        if (message.isEmpty()) {
            return "ë­”ê°€ ë§í•´ ì¤˜! ë“£ê³  ìˆì„ê²Œ ğŸ™‚";
        }

        if (containsAny(message, List.of("í˜ë“¤", "ìš°ìš¸", "ì§œì¦", "í”¼ê³¤"))) {
            return switch (mbti.substring(0, 2)) {
                case "EN", "ES" -> "í—‰â€¦ ê´œì°®ì•„? ğŸ¥º ë¬´ìŠ¨ ì¼ ìˆì—ˆëŠ”ì§€ ë§í•´ì¤„ë˜? ë‚´ê°€ ëê¹Œì§€ ë“¤ì–´ì¤„ê²Œ.";
                case "IN", "IS" -> "ë§ì´ í˜ë“¤ì—ˆê² ë‹¤â€¦ ì²œì²œíˆ ë§í•´ì¤˜ë„ ê´œì°®ì•„. ë‚´ê°€ ì¡°ìš©íˆ ë“¤ì–´ì¤„ê²Œ.";
                default -> "ìƒí™©ì´ ê½¤ ë²„ê±°ì› ë‚˜ ë³´ë‹¤. í˜¹ì‹œ ì–´ë–¤ ì ì´ ì œì¼ í˜ë“¤ì—ˆëŠ”ì§€ ì´ì•¼ê¸°í•´ë³¼ë˜?";
            };
        }

        if (containsAny(message, List.of("ê³ ë¯¼", "ì–´ë–¡í•´", "ì–´ë–»ê²Œ í•´", "ì–´ë–»ê²Œ í•´ì•¼"))) {
            return switch (mbti.substring(2)) {
                case "TJ" -> "ì¼ë‹¨ ìƒí™©ì„ ëª‡ ê°€ì§€ë¡œ ë‚˜ëˆ ë³´ì. ì„ íƒì§€ A, B, Cë¥¼ ìƒê°í•´ë³´ê³  ê°ê° ì¥ë‹¨ì ì„ ê°™ì´ ë”°ì ¸ë³¼ê¹Œ?";
                case "FP" -> "ë§ˆìŒì´ ë§ì´ ë³µì¡í•˜ê² ë‹¤â€¦ ë„¤ê°€ ì§„ì§œ ì›í•˜ëŠ” ê²Œ ë­”ì§€ë¶€í„° ê°™ì´ ì •ë¦¬í•´ë³¼ê¹Œ?";
                default -> "ë‚´ê°€ ëŠë¼ê¸°ì—”, ë„ˆë¬´ í˜¼ì ê³ ë¯¼í•˜ì§€ ë§ê³  í•˜ë‚˜ì”© ìª¼ê°œì„œ ìƒê°í•´ë³´ë©´ ì¢‹ì„ ê²ƒ ê°™ì•„.";
            };
        }

        if (containsAny(message, List.of("ì•ˆë…•", "í•˜ì´", "ë°˜ê°€ì›Œ"))) {
            return switch (mbti) {
                case "ENFP", "ESFP" ->
                        "ì•ˆë…•!! ğŸ™Œ ì˜¤ëŠ˜ í•˜ë£¨ ì–´ë• ì–´? ì•„ë¬´ ì–˜ê¸°ë‚˜ í¸í•˜ê²Œ í•´ì¤˜~";
                case "INTJ", "ISTJ" ->
                        "ì•ˆë…•. ì˜¤ëŠ˜ì€ ì–´ë–¤ ì´ì•¼ê¸°ë¶€í„° í•´ë³¼ê¹Œ?";
                default ->
                        "ë°˜ê°€ì›Œ :) ìš”ì¦˜ì€ ì–´ë–»ê²Œ ì§€ë‚´ê³  ìˆì–´?";
            };
        }

        // 3. ê¸°ë³¸ ì‘ë‹µ í…œí”Œë¦¿
        return switch (mbti) {
            case "ENFP" -> "ì´ ì–˜ê¸° ë“¤ìœ¼ë‹ˆê¹Œ ë„ˆ ìƒê°ì´ ë” ê¶ê¸ˆí•´ì¡Œì–´! ğŸ‘‰ \"" + message + "\" ì´ ë¶€ë¶„, ë„¤ ì…ì¥ì—ì„  ì–´ë• ì–´?";
            case "INFP" -> "ê·¸ë ‡ê²Œ ëŠë‚€ ì´ìœ ê°€ ë‚˜ë¦„ ì˜ ì´í•´ë¼â€¦ \"" + message + "\" ë¼ëŠ” ë§ ì•ˆì— ë„¤ ë§ˆìŒì´ ë§ì´ ë‹´ê²¨ ìˆëŠ” ê²ƒ ê°™ì•„.";
            case "ENTJ" -> "ì •ë¦¬í•´ë³´ë©´, ì§€ê¸ˆ ìƒí™©ì€ \"" + message + "\" ì´ê³ , ê·¸ë˜ì„œ ë‹¤ìŒ ì•¡ì…˜ì„ ì–´ë–»ê²Œ ê°€ì ¸ê°ˆì§€ê°€ í¬ì¸íŠ¸ ê°™ì•„.";
            case "INTJ" -> "ìŒ, ë…¼ë¦¬ì ìœ¼ë¡œ ë³´ë©´ \"" + message + "\" ë¼ëŠ” ê±´ ê½¤ ì˜ë¯¸ ìˆëŠ” í¬ì¸íŠ¸ì•¼. ì¡°ê¸ˆ ë” ê¹Šê²Œ ë¶„ì„í•´ë³¼ê¹Œ?";
            case "ESFJ" -> "ì´ì•¼ê¸°í•´ì¤˜ì„œ ê³ ë§ˆì›Œ. \"" + message + "\" ë¼ê³  ë§í•  ì •ë„ë©´, ë„¤ê°€ ê½¤ ì‹ ê²½ ì“°ê³  ìˆë‹¤ëŠ” ëœ» ê°™ì•„.";
            case "ISFJ" -> "ìƒê°ë³´ë‹¤ ë§ì´ ì‹ ê²½ ì“°ì˜€ê² ë‹¤â€¦ \"" + message + "\" ì´ëŸ° ë§ í•˜ê¸°ê¹Œì§€ ê³ ë¯¼ ë§ì•˜ì„ ê²ƒ ê°™ì•„.";
            case "ESTP" -> "ì˜¤ ì¬ë°ŒëŠ”ë°? ğŸ˜‚ \"" + message + "\" ì´ ìƒí™©ì´ë©´, ì¼ë‹¨ í–‰ë™ë¶€í„° í•´ë³´ëŠ” ê²ƒë„ ë‚˜ì˜ì§€ ì•Šì„ ë“¯!";
            case "ISTP" -> "ìŒ, \"" + message + "\" ì´ë©´.. ì¼ë‹¨ ê³¼í•˜ê²Œ ê³ ë¯¼í•˜ê¸°ë³´ë‹¨, ìµœì†Œí•œìœ¼ë¡œ ì›€ì§ì´ë©´ì„œ ë²„ê·¸(?)ë¥¼ ì°¾ëŠ” ëŠë‚Œìœ¼ë¡œ ê°€ë³´ì.";
            default -> "ì–˜ê¸°í•´ì¤˜ì„œ ê³ ë§ˆì›Œ. \"" + message + "\" ë¼ëŠ” ë§ì„ í•œ ë„ˆì˜ ë§ˆìŒì´ ê¶ê¸ˆí•´ì§€ë„¤.";
        };
    }

    private boolean containsAny(String text, List<String> keywords) {
        for (String k : keywords) {
            if (text.contains(k)) return true;
        }
        return false;
    }
}
