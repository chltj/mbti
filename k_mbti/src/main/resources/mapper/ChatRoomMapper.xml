<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.k_mbti.dao.ChatDao">

    <!-- ë°© ResultMap -->
    <resultMap id="ChatRoomResultMap" type="com.example.k_mbti.dto.ChatRoomDto">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="maxCount" column="max_count"/>
        <result property="owner" column="owner"/>
        <result property="currentCount" column="current_count"/>
    </resultMap>

    <!-- ë°© ìƒì„± -->
    <insert id="insertRoom" parameterType="com.example.k_mbti.dto.ChatRoomDto"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO chat_room (name, max_count, owner)
        VALUES (#{name}, #{maxCount}, #{owner})
    </insert>

    <!-- ë°© ë©¤ë²„ ì¶”ê°€ -->
    <insert id="insertMember">
        INSERT INTO chat_room_member (room_id, nickname)
        VALUES (#{roomId}, #{nickname})
    </insert>

    <!-- ë‹¨ì¼ ë°© ì¡°íšŒ -->
    <select id="findRoomById" parameterType="long" resultMap="ChatRoomResultMap">
        SELECT
            r.id,
            r.name,
            r.max_count,
            r.owner,
            (SELECT COUNT(*) FROM chat_room_member m WHERE m.room_id = r.id) AS current_count
        FROM chat_room r
        WHERE r.id = #{roomId}   <!-- ðŸ”¥ ì—¬ê¸° ë°˜ë“œì‹œ roomId -->
    </select>

    <!-- ì „ì²´ ë°© ëª©ë¡ -->
    <select id="findAllRooms" resultMap="ChatRoomResultMap">
        SELECT
            r.id,
            r.name,
            r.max_count,
            r.owner,
            (SELECT COUNT(*) FROM chat_room_member m WHERE m.room_id = r.id) AS current_count
        FROM chat_room r
        ORDER BY r.id DESC
    </select>

    <!-- íŠ¹ì • ìœ ì €ê°€ ì°¸ì—¬í•œ ë°© ëª©ë¡ -->
    <select id="findRoomsByMember" parameterType="string" resultMap="ChatRoomResultMap">
        SELECT
            r.id,
            r.name,
            r.max_count,
            r.owner,
            (SELECT COUNT(*) FROM chat_room_member m2 WHERE m2.room_id = r.id) AS current_count
        FROM chat_room r
        JOIN chat_room_member m ON r.id = m.room_id
        WHERE m.nickname = #{nickname}
        ORDER BY r.id DESC
    </select>

    <!-- ë°© ë©¤ë²„ ëª©ë¡ -->
    <select id="findMembersByRoomId" parameterType="long" resultType="string">
        SELECT nickname
        FROM chat_room_member
        WHERE room_id = #{roomId}
        ORDER BY joined_at ASC
    </select>

    <!-- ë©”ì‹œì§€ ì €ìž¥ -->
    <insert id="insertMessage" parameterType="com.example.k_mbti.dto.ChatMessageDto">
        INSERT INTO chat_message (room_id, sender, message, sent_at)
        VALUES (#{roomId}, #{sender}, #{content}, #{sentAt})
    </insert>

    <!-- ë©”ì‹œì§€ ëª©ë¡ -->
    <select id="findMessagesByRoomId" parameterType="long"
            resultType="com.example.k_mbti.dto.ChatMessageDto">
        SELECT
            id,
            room_id    AS roomId,
            sender,
            message    AS content,
            sent_at    AS sentAt
        FROM chat_message
        WHERE room_id = #{roomId}
        ORDER BY sent_at ASC, id ASC
    </select>

    <!-- ë‹‰ë„¤ìž„ ë³€ê²½ -->
    <update id="updateMemberNickname">
        UPDATE chat_room_member
        SET nickname = #{newNickname}
        WHERE nickname = #{oldNickname}
    </update>

</mapper>
